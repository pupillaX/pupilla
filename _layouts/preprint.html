---
layout: default
---
<article class="preprint">
  <header>
    <h1>{{ page.title }}</h1>
    {% if page.authors %}
    <p class="authors">{{ page.authors | join: ', ' }}</p>
    {% endif %}
    <div class="preprint-tags">
      {% comment %}
      {% if page.discipline %}
        <span class="discipline-tag">{{ page.discipline }}</span>
      {% endif %}
      {% endcomment %}
      {% if page.language %}
        {% if page.language.size %}
          {% for lang in page.language %}
            <span class="language-tag">{{ lang }}</span>
          {% endfor %}
        {% else %}
          <span class="language-tag">{{ page.language }}</span>
        {% endif %}
      {% endif %}
      {% if page.coming_soon %}
        <span class="coming-soon-tag">COMING SOON</span>
      {% endif %}
    </div>
    {% if page.doi %}
    <p class="meta">DOI: {{ page.doi }}</p>
    {% endif %}
    {% if page.date and page.coming_soon != true %}
    <p class="meta">Date: {{ page.date | date: '%Y-%m-%d' }}</p>
    {% endif %}
    
    <!-- Visit and Download Counters -->
    <div class="preprint-stats">
      <span class="stat-item">
        <span class="stat-icon">üëÅ</span>
        <span id="visit-count">Loading...</span> visits
      </span>
      {% if page.pdf or page.pdfs %}
      <span class="stat-item">
        <span class="stat-icon">üì•</span>
        <span id="download-count">Loading...</span> downloads
      </span>
      {% endif %}
    </div>
  </header>
  {% if page.abstract %}
  <section class="abstract">
    <h2>Abstract</h2>
    <p>{{ page.abstract }}</p>
  </section>
  {% endif %}
  
  <!-- PDF Downloads Section -->
  {% if page.pdfs %}
    <!-- Multiple language-specific PDFs -->
    <div class="pdf-downloads">
      <h3>Download PDF</h3>
      <div class="pdf-buttons">
        {% for pdf in page.pdfs %}
          <a class="btn pdf-btn" href="{{ pdf.url | relative_url }}" target="_blank" rel="noopener" data-lang="{{ pdf.language | downcase }}">
            <span class="flag-icon">{{ pdf.flag | default: "üìÑ" }}</span>
            {{ pdf.language }}
          </a>
        {% endfor %}
      </div>
    </div>
  {% elsif page.pdf %}
    <!-- Single PDF -->
    <p><a class="btn download-btn" href="{{ page.pdf | relative_url }}" target="_blank" rel="noopener">üìÑ Download PDF</a></p>
  {% elsif page.coming_soon %}
    <p><span class="btn btn-disabled">üìÑ PDF Coming Soon</span></p>
  {% endif %}
  <section class="content">
    {{ content }}
  </section>
</article>

<script>
// Pupilla Analytics - Hybrid counter system with fallback
console.log('Pupilla Analytics: Starting initialization');

const PAGE_KEY = '{{ page.url | slugify }}';
const STORAGE_PREFIX = 'pupilla-analytics';

// Fallback localStorage functions
function getLocalCount(type) {
  const key = `${STORAGE_PREFIX}-${type}-${PAGE_KEY}`;
  const count = localStorage.getItem(key);
  return count ? parseInt(count, 10) : 0;
}

function setLocalCount(type, count) {
  const key = `${STORAGE_PREFIX}-${type}-${PAGE_KEY}`;
  localStorage.setItem(key, count.toString());
}

function incrementLocalCount(type) {
  const currentCount = getLocalCount(type);
  const newCount = currentCount + 1;
  setLocalCount(type, newCount);
  return newCount;
}

// Server-side counter with fallback
async function initializeCounters() {
  console.log('Pupilla Analytics: Initializing counters for page:', PAGE_KEY);
  
  try {
    // Try using a different free counter service (api.countapi.xyz might be down)
    const visitUrl = `https://api.countapi.xyz/hit/pupilla-org/visits-${PAGE_KEY}`;
    console.log('Pupilla Analytics: Attempting to fetch visit count from:', visitUrl);
    
    const visitResponse = await fetch(visitUrl, {
      method: 'GET',
      mode: 'cors'
    });
    
    if (visitResponse.ok) {
      const visitData = await visitResponse.json();
      console.log('Pupilla Analytics: Server response for visits:', visitData);
      
      if (visitData.value !== undefined) {
        updateVisitDisplay(visitData.value);
        console.log('Pupilla Analytics: Visit count from server:', visitData.value);
      } else {
        throw new Error('Invalid server response for visits');
      }
    } else {
      throw new Error(`Server responded with status: ${visitResponse.status}`);
    }
    
    // Get download counter
    const downloadUrl = `https://api.countapi.xyz/get/pupilla-org/downloads-${PAGE_KEY}`;
    const downloadResponse = await fetch(downloadUrl, { mode: 'cors' });
    
    if (downloadResponse.ok) {
      const downloadData = await downloadResponse.json();
      console.log('Pupilla Analytics: Server response for downloads:', downloadData);
      
      if (downloadData.value !== undefined) {
        updateDownloadDisplay(downloadData.value);
        console.log('Pupilla Analytics: Download count from server:', downloadData.value);
      } else {
        // Initialize download counter
        await fetch(`https://api.countapi.xyz/set/pupilla-org/downloads-${PAGE_KEY}?value=0`, { mode: 'cors' });
        updateDownloadDisplay(0);
      }
    } else {
      updateDownloadDisplay(getLocalCount('downloads'));
    }
    
  } catch (error) {
    console.warn('Pupilla Analytics: Server counters failed, using local fallback:', error);
    
    // Fallback to localStorage
    const visitCount = getLocalCount('visits');
    const downloadCount = getLocalCount('downloads');
    
    // Auto-increment visit count for new sessions
    const sessionKey = `pupilla-session-${PAGE_KEY}`;
    if (!sessionStorage.getItem(sessionKey)) {
      const newVisitCount = incrementLocalCount('visits');
      updateVisitDisplay(newVisitCount);
      sessionStorage.setItem(sessionKey, 'true');
      console.log('Pupilla Analytics: New session, visit count incremented to:', newVisitCount);
    } else {
      updateVisitDisplay(visitCount);
      console.log('Pupilla Analytics: Returning session, visit count:', visitCount);
    }
    
    updateDownloadDisplay(downloadCount);
    console.log('Pupilla Analytics: Using local download count:', downloadCount);
  }
}

// Increment download counter
async function incrementDownloadCounter() {
  try {
    const response = await fetch(`https://api.countapi.xyz/hit/pupilla-org/downloads-${PAGE_KEY}`, { mode: 'cors' });
    
    if (response.ok) {
      const data = await response.json();
      if (data.value !== undefined) {
        updateDownloadDisplay(data.value);
        console.log('Pupilla Analytics: Server download count incremented to:', data.value);
        return;
      }
    }
    throw new Error('Server increment failed');
  } catch (error) {
    console.warn('Pupilla Analytics: Server download increment failed, using local:', error);
    const count = incrementLocalCount('downloads');
    updateDownloadDisplay(count);
    console.log('Pupilla Analytics: Local download count incremented to:', count);
  }
}

// Google Analytics Events (keep for data collection)
function trackPageView() {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'page_view', {
      'page_title': '{{ page.title | escape }}',
      'page_location': window.location.href,
      'custom_parameter_1': 'preprint_view',
      'send_to': '{{ site.google_analytics }}'
    });
    console.log('GA: Page view tracked for:', '{{ page.title | escape }}');
  } else {
    console.log('GA: Not available, page view not tracked');
  }
}

function trackDownload(filename, language) {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'file_download', {
      'file_name': filename,
      'file_extension': 'pdf',
      'page_title': '{{ page.title | escape }}',
      'language': language || 'default',
      'link_url': filename,
      'value': 1,
      'send_to': '{{ site.google_analytics }}'
    });
    console.log('GA: Download tracked:', filename);
  } else {
    console.log('GA: Not available, download not tracked');
  }
}

function updateVisitDisplay(count) {
  const visitCountEl = document.getElementById('visit-count');
  if (visitCountEl) {
    visitCountEl.textContent = count;
  }
}

function updateDownloadDisplay(count) {
  const downloadCountEl = document.getElementById('download-count');
  if (downloadCountEl) {
    downloadCountEl.textContent = count;
  }
}

// Enhanced download tracking for PDF links
async function handlePDFDownload(pdfUrl, language) {
  const filename = pdfUrl.split('/').pop();
  
  // Track in Google Analytics
  trackDownload(pdfUrl, language);
  
  // Increment server-side counter
  await incrementDownloadCounter();
}

// Initialize counters and tracking
document.addEventListener('DOMContentLoaded', function() {
  console.log('Pupilla Analytics: Initializing for:', '{{ page.title | escape }}');
  
  // Initialize server-side counters
  initializeCounters();
  
  // Track page view in Google Analytics
  trackPageView();
  
  // Add click tracking to all PDF download links
  const pdfLinks = document.querySelectorAll('a[href$=".pdf"], a[href*=".pdf"]');
  pdfLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      const pdfUrl = this.getAttribute('href');
      const language = this.getAttribute('data-lang') || 
                      this.textContent.match(/\(([^)]+)\)/)?.[1] ||
                      this.textContent.trim() || 
                      'default';
      
      console.log('PDF link clicked:', pdfUrl, 'Language:', language);
      handlePDFDownload(pdfUrl, language);
    });
  });
  
  console.log('Pupilla Analytics: Found', pdfLinks.length, 'PDF links');
  console.log('Pupilla Analytics: Google Analytics available:', typeof gtag !== 'undefined');
  console.log('Pupilla Analytics: Tracking ID:', '{{ site.google_analytics }}');
});
</script>
