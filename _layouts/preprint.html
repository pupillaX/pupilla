---
layout: default
---
<article class="preprint">
  <header>
    <h1>{{ page.title }}</h1>
    {% if page.authors %}
    <p class="authors">{{ page.authors | join: ', ' }}</p>
    {% endif %}
    <div class="preprint-tags">
      {% if page.discipline %}
        <span class="discipline-tag">{{ page.discipline }}</span>
      {% endif %}
      {% if page.language %}
        {% if page.language.size %}
          {% for lang in page.language %}
            <span class="language-tag">{{ lang }}</span>
          {% endfor %}
        {% else %}
          <span class="language-tag">{{ page.language }}</span>
        {% endif %}
      {% endif %}
      {% if page.coming_soon %}
        <span class="coming-soon-tag">COMING SOON</span>
      {% endif %}
    </div>
    {% if page.doi %}
    <p class="meta">DOI: {{ page.doi }}</p>
    {% endif %}
    {% if page.date and page.coming_soon != true %}
    <p class="meta">Date: {{ page.date | date: '%Y-%m-%d' }}</p>
    {% endif %}
    
    <!-- Visit and Download Counters -->
    <div class="preprint-stats">
      <span class="stat-item">
        <span class="stat-icon">üëÅ</span>
        <span id="visit-count">Loading...</span> visits
      </span>
      {% if page.pdf or page.pdfs %}
      <span class="stat-item">
        <span class="stat-icon">üì•</span>
        <span id="download-count">Loading...</span> downloads
      </span>
      {% endif %}
      <!-- Debug button - remove after testing -->
      <button onclick="testCounters()" style="margin-left: 10px; padding: 5px; font-size: 12px;">Test Counters</button>
    </div>
  </header>
  {% if page.abstract %}
  <section class="abstract">
    <h2>Abstract</h2>
    <p>{{ page.abstract }}</p>
  </section>
  {% endif %}
  
  <!-- PDF Downloads Section -->
  {% if page.pdfs %}
    <!-- Multiple language-specific PDFs -->
    <div class="pdf-downloads">
      <h3>Download PDF</h3>
      <div class="pdf-buttons">
        {% for pdf in page.pdfs %}
          <a class="btn pdf-btn" href="{{ pdf.url | relative_url }}" target="_blank" rel="noopener" data-lang="{{ pdf.language | downcase }}">
            <span class="flag-icon">{{ pdf.flag | default: "üìÑ" }}</span>
            {{ pdf.language }}
          </a>
        {% endfor %}
      </div>
    </div>
  {% elsif page.pdf %}
    <!-- Single PDF -->
    <p><a class="btn download-btn" href="{{ page.pdf | relative_url }}" target="_blank" rel="noopener">üìÑ Download PDF</a></p>
  {% elsif page.coming_soon %}
    <p><span class="btn btn-disabled">üìÑ PDF Coming Soon</span></p>
  {% endif %}
  <section class="content">
    {{ content }}
  </section>
</article>

<script>
// Global Analytics Tracking System
// Combines Google Analytics for worldwide data with localStorage for immediate feedback

function getStorageKey(type) {
  return `pupilla_${type}_${window.location.pathname}`;
}

function getLocalCount(type) {
  return parseInt(localStorage.getItem(getStorageKey(type)) || '0');
}

function setLocalCount(type, count) {
  localStorage.setItem(getStorageKey(type), count.toString());
}

function incrementLocalCount(type) {
  const currentCount = getLocalCount(type);
  const newCount = currentCount + 1;
  setLocalCount(type, newCount);
  return newCount;
}

// Google Analytics Events
function trackPageView() {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'page_view', {
      'page_title': '{{ page.title | escape }}',
      'page_location': window.location.href,
      'content_group1': '{{ page.discipline | escape }}',
      'custom_parameter_1': 'preprint_view',
      'send_to': '{{ site.google_analytics }}'
    });
    console.log('GA: Page view tracked for:', '{{ page.title | escape }}');
  } else {
    console.log('GA: Not available, page view not tracked');
  }
}

function trackDownload(filename, language) {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'file_download', {
      'file_name': filename,
      'file_extension': 'pdf',
      'page_title': '{{ page.title | escape }}',
      'content_group1': '{{ page.discipline | escape }}',
      'language': language || 'default',
      'link_url': filename,
      'value': 1,
      'send_to': '{{ site.google_analytics }}'
    });
    console.log('GA: Download tracked:', filename);
  } else {
    console.log('GA: Not available, download not tracked');
  }
}

function incrementVisitCount() {
  // Track in Google Analytics for global data
  trackPageView();
  
  // Update local counter for immediate feedback
  const count = incrementLocalCount('visits');
  updateVisitDisplay(count);
  
  return count;
}

function incrementDownloadCount(filename, language) {
  // Track in Google Analytics for global data
  trackDownload(filename, language);
  
  // Update local counters for immediate feedback
  const downloadType = language ? `downloads_${language}` : 'downloads';
  const langCount = incrementLocalCount(downloadType);
  const totalCount = incrementLocalCount('downloads');
  
  updateDownloadDisplay(totalCount, language, langCount);
  
  return totalCount;
}

function updateVisitDisplay(count) {
  const visitCountEl = document.getElementById('visit-count');
  if (visitCountEl) {
    visitCountEl.textContent = count;
  }
}

function updateDownloadDisplay(totalCount, language, langCount) {
  const downloadCountEl = document.getElementById('download-count');
  if (downloadCountEl) {
    downloadCountEl.textContent = totalCount;
  }
  
  // Update language-specific count if element exists
  if (language) {
    const langCountEl = document.getElementById(`download-count-${language}`);
    if (langCountEl) {
      langCountEl.textContent = langCount;
    }
  }
}

// Enhanced download tracking for PDF links
function handlePDFDownload(pdfUrl, language) {
  const filename = pdfUrl.split('/').pop();
  incrementDownloadCount(pdfUrl, language);
}

// Initialize counters and tracking
document.addEventListener('DOMContentLoaded', function() {
  console.log('Pupilla Analytics: Initializing for:', '{{ page.title | escape }}');
  
  // Check if this is a new visit (not just a page refresh)
  const sessionKey = `pupilla_session_${window.location.pathname}`;
  const hasVisitedThisSession = sessionStorage.getItem(sessionKey);
  
  if (!hasVisitedThisSession) {
    console.log('Pupilla Analytics: New session, tracking visit');
    incrementVisitCount();
    sessionStorage.setItem(sessionKey, 'true');
  } else {
    console.log('Pupilla Analytics: Returning visitor in same session');
    // Just display current local count
    const visitCount = getLocalCount('visits');
    console.log('Pupilla Analytics: Current visit count:', visitCount);
    updateVisitDisplay(visitCount);
  }
  
  // Display download count
  const downloadCountEl = document.getElementById('download-count');
  if (downloadCountEl) {
    const downloadCount = getLocalCount('downloads');
    console.log('Pupilla Analytics: Current download count:', downloadCount);
    updateDownloadDisplay(downloadCount);
  } else {
    console.log('Pupilla Analytics: No download counter element found');
  }
  
  // Add click tracking to all PDF download links
  const pdfLinks = document.querySelectorAll('a[href$=".pdf"], a[href*=".pdf"]');
  pdfLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      const pdfUrl = this.getAttribute('href');
      const language = this.getAttribute('data-lang') || 
                      this.textContent.match(/\(([^)]+)\)/)?.[1] ||
                      this.textContent.trim() || 
                      'default';
      
      console.log('PDF link clicked:', pdfUrl, 'Language:', language);
      handlePDFDownload(pdfUrl, language);
    });
  });
  
  console.log('Pupilla Analytics: Found', pdfLinks.length, 'PDF links');
  
  console.log('Pupilla Analytics: Google Analytics available:', typeof gtag !== 'undefined');
  console.log('Pupilla Analytics: Tracking ID:', '{{ site.google_analytics }}');
  
  // Debug function for testing
  window.testCounters = function() {
    console.log('=== COUNTER TEST ===');
    console.log('Visit count:', getLocalCount('visits'));
    console.log('Download count:', getLocalCount('downloads'));
    console.log('Visit element:', document.getElementById('visit-count'));
    console.log('Download element:', document.getElementById('download-count'));
    
    // Test increment
    const newVisit = incrementLocalCount('visits');
    const newDownload = incrementLocalCount('downloads');
    console.log('New visit count:', newVisit);
    console.log('New download count:', newDownload);
    
    // Update display
    updateVisitDisplay(newVisit);
    updateDownloadDisplay(newDownload);
    console.log('=== END TEST ===');
  };
});
</script>

