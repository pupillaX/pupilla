---
layout: default
---
<article class="preprint">
  <header>
    <h1>{{ page.title }}</h1>
    {% if page.authors %}
    <p class="authors">{{ page.authors | join: ', ' }}</p>
    {% endif %}
    <div class="preprint-tags">
      {% comment %}
      {% if page.discipline %}
        <span class="discipline-tag">{{ page.discipline }}</span>
      {% endif %}
      {% endcomment %}
      {% if page.language %}
        {% if page.language.size %}
          {% for lang in page.language %}
            <span class="language-tag">{{ lang }}</span>
          {% endfor %}
        {% else %}
          <span class="language-tag">{{ page.language }}</span>
        {% endif %}
      {% endif %}
      {% if page.coming_soon %}
        <span class="coming-soon-tag">COMING SOON</span>
      {% endif %}
    </div>
    {% if page.doi %}
    <p class="meta">DOI: {{ page.doi }}</p>
    {% endif %}
    {% if page.date and page.coming_soon != true %}
    <p class="meta">Date: {{ page.date | date: '%Y-%m-%d' }}</p>
    {% endif %}
    
    <!-- Visit and Download Counters -->
    <div class="preprint-stats">
      <span class="stat-item">
        <span class="stat-icon">üëÅ</span>
        <span id="visit-count">Loading...</span> visits
      </span>
      {% if page.pdf or page.pdfs %}
      <span class="stat-item">
        <span class="stat-icon">üì•</span>
        <span id="download-count">Loading...</span> downloads
      </span>
      {% endif %}
    </div>
  </header>
  {% if page.abstract %}
  <section class="abstract">
    <h2>Abstract</h2>
    <p>{{ page.abstract }}</p>
  </section>
  {% endif %}
  
  <!-- PDF Downloads Section -->
  {% if page.pdfs %}
    <!-- Multiple language-specific PDFs -->
    <div class="pdf-downloads">
      <h3>Download PDF</h3>
      <div class="pdf-buttons">
        {% for pdf in page.pdfs %}
          <a class="btn pdf-btn" href="{{ pdf.url | relative_url }}" target="_blank" rel="noopener" data-lang="{{ pdf.language | downcase }}">
            <span class="flag-icon">{{ pdf.flag | default: "üìÑ" }}</span>
            {{ pdf.language }}
          </a>
        {% endfor %}
      </div>
    </div>
  {% elsif page.pdf %}
    <!-- Single PDF -->
    <p><a class="btn download-btn" href="{{ page.pdf | relative_url }}" target="_blank" rel="noopener">üìÑ Download PDF</a></p>
  {% elsif page.coming_soon %}
    <p><span class="btn btn-disabled">üìÑ PDF Coming Soon</span></p>
  {% endif %}
  <section class="content">
    {{ content }}
  </section>
</article>

<script>
// Pupilla Analytics - Google Analytics Integration
console.log('Pupilla Analytics: Starting initialization');

const PAGE_PATH = '{{ page.url }}';
const PAGE_TITLE = '{{ page.title | escape }}';

// Google Analytics 4 Measurement Protocol for real-time data
// Note: This requires setting up GA4 properly with custom events

// For development/testing - simple local fallback
function getLocalCount(type) {
  const key = `pupilla-${type}-${PAGE_PATH}`;
  const count = localStorage.getItem(key);
  return count ? parseInt(count, 10) : 0;
}

function incrementLocalCount(type) {
  const key = `pupilla-${type}-${PAGE_PATH}`;
  const currentCount = getLocalCount(type);
  const newCount = currentCount + 1;
  localStorage.setItem(key, newCount.toString());
  return newCount;
}

// Google Analytics Enhanced eCommerce and Events
function trackPageView() {
  if (typeof gtag !== 'undefined') {
    // Enhanced page view tracking with custom dimensions
    gtag('config', '{{ site.google_analytics }}', {
      page_title: PAGE_TITLE,
      page_location: window.location.href,
      custom_map: {
        'custom_parameter_1': 'page_type',
        'custom_parameter_2': 'content_group'
      }
    });
    
    gtag('event', 'page_view', {
      page_title: PAGE_TITLE,
      page_location: window.location.href,
      content_group1: 'preprint',
      custom_parameter_1: 'preprint_view',
      value: 1
    });
    
    console.log('GA: Enhanced page view tracked for:', PAGE_TITLE);
  }
}

function trackDownload(filename, language) {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'file_download', {
      file_name: filename,
      file_extension: 'pdf',
      page_title: PAGE_TITLE,
      language: language || 'default',
      link_url: filename,
      content_group1: 'preprint',
      value: 1
    });
    
    // Also track as a conversion event
    gtag('event', 'download_pdf', {
      event_category: 'engagement',
      event_label: filename,
      value: 1
    });
    
    console.log('GA: Download tracked:', filename, 'Language:', language);
  }
}

// Google Analytics Data API integration (requires API key)
async function fetchGoogleAnalyticsData() {
  // This would require setting up Google Analytics Data API
  // For now, we'll simulate with local storage but prepare for real GA data
  
  console.log('Pupilla Analytics: Checking for GA data...');
  
  // Check if we have Google Analytics gtag loaded
  if (typeof gtag === 'undefined') {
    console.log('Pupilla Analytics: Google Analytics not loaded, using local fallback');
    return null;
  }
  
  // For production, you would implement GA4 Data API calls here
  // This requires server-side implementation or a proxy service
  console.log('Pupilla Analytics: GA loaded, but Data API not configured yet');
  return null;
}

function updateVisitDisplay(count) {
  const visitCountEl = document.getElementById('visit-count');
  if (visitCountEl) {
    visitCountEl.textContent = count;
  }
}

function updateDownloadDisplay(count) {
  const downloadCountEl = document.getElementById('download-count');
  if (downloadCountEl) {
    downloadCountEl.textContent = count;
  }
}

// Global counter system using simple external service
const PAGE_SLUG = PAGE_PATH.replace(/[^a-zA-Z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');

// Initialize global counters
async function initializeCounters() {
  console.log('Pupilla Analytics: Initializing global counters for:', PAGE_PATH);
  
  try {
    // Use Goat Counter (privacy-friendly, GDPR compliant)
    // Alternative: Use a simple counter API that works with static sites
    
    // For now, use a simple approach with Firebase or similar
    // This creates truly global counters shared across all devices
    
    const sessionKey = `pupilla-session-${PAGE_SLUG}`;
    const isNewSession = !sessionStorage.getItem(sessionKey);
    
    if (isNewSession) {
      // Increment global visit counter
      await incrementGlobalVisitCounter();
      sessionStorage.setItem(sessionKey, 'true');
      console.log('Pupilla Analytics: New global session recorded');
    }
    
    // Load current global counts
    await loadGlobalCounts();
    
  } catch (error) {
    console.error('Pupilla Analytics: Error with global counters:', error);
    // Fallback to local if global service fails
    initializeLocalCounters();
  }
}

// Global counter functions using a simple API
async function incrementGlobalVisitCounter() {
  try {
    // Using a simple counter service that provides global counting
    const response = await fetch(`https://api.countapi.xyz/hit/pupilla-org-v2/visits-${PAGE_SLUG}`, {
      method: 'GET',
      mode: 'cors'
    });
    
    if (response.ok) {
      const data = await response.json();
      updateVisitDisplay(data.value || 1);
      console.log('Pupilla Analytics: Global visit count:', data.value);
    } else {
      throw new Error('Global counter service unavailable');
    }
  } catch (error) {
    console.warn('Pupilla Analytics: Global visit counter failed, using local');
    const count = incrementLocalCount('visits');
    updateVisitDisplay(count);
  }
}

async function incrementGlobalDownloadCounter() {
  try {
    const response = await fetch(`https://api.countapi.xyz/hit/pupilla-org-v2/downloads-${PAGE_SLUG}`, {
      method: 'GET',
      mode: 'cors'
    });
    
    if (response.ok) {
      const data = await response.json();
      updateDownloadDisplay(data.value || 1);
      console.log('Pupilla Analytics: Global download count:', data.value);
      return data.value;
    } else {
      throw new Error('Global counter service unavailable');
    }
  } catch (error) {
    console.warn('Pupilla Analytics: Global download counter failed, using local');
    const count = incrementLocalCount('downloads');
    updateDownloadDisplay(count);
    return count;
  }
}

async function loadGlobalCounts() {
  try {
    // Load current visit count
    const visitResponse = await fetch(`https://api.countapi.xyz/get/pupilla-org-v2/visits-${PAGE_SLUG}`, {
      mode: 'cors'
    });
    
    if (visitResponse.ok) {
      const visitData = await visitResponse.json();
      updateVisitDisplay(visitData.value || 0);
    }
    
    // Load current download count
    const downloadResponse = await fetch(`https://api.countapi.xyz/get/pupilla-org-v2/downloads-${PAGE_SLUG}`, {
      mode: 'cors'
    });
    
    if (downloadResponse.ok) {
      const downloadData = await downloadResponse.json();
      updateDownloadDisplay(downloadData.value || 0);
    }
    
    console.log('Pupilla Analytics: Global counts loaded successfully');
    
  } catch (error) {
    console.warn('Pupilla Analytics: Could not load global counts');
    // Show local counts as fallback
    updateVisitDisplay(getLocalCount('visits'));
    updateDownloadDisplay(getLocalCount('downloads'));
  }
}

// Fallback to local counters
function initializeLocalCounters() {
  const sessionKey = `pupilla-session-${PAGE_SLUG}`;
  const isNewSession = !sessionStorage.getItem(sessionKey);
  
  if (isNewSession) {
    const visitCount = incrementLocalCount('visits');
    updateVisitDisplay(visitCount);
    sessionStorage.setItem(sessionKey, 'true');
    console.log('Pupilla Analytics: Local fallback - new session, visit count:', visitCount);
  } else {
    const visitCount = getLocalCount('visits');
    updateVisitDisplay(visitCount);
    console.log('Pupilla Analytics: Local fallback - returning session, visit count:', visitCount);
  }
  
  const downloadCount = getLocalCount('downloads');
  updateDownloadDisplay(downloadCount);
}

function incrementDownloadCounter() {
  // Use global counter, fallback to local if failed
  return incrementGlobalDownloadCounter();
}

function handlePDFDownload(pdfUrl, language) {
  const filename = pdfUrl.split('/').pop();
  
  // Track in Google Analytics (for future data aggregation)
  trackDownload(pdfUrl, language);
  
  // Update local counter for immediate feedback
  incrementDownloadCounter();
}

// Google Analytics Events (keep for data collection)
function trackPageView() {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'page_view', {
      'page_title': '{{ page.title | escape }}',
      'page_location': window.location.href,
      'custom_parameter_1': 'preprint_view',
      'send_to': '{{ site.google_analytics }}'
    });
    console.log('GA: Page view tracked for:', '{{ page.title | escape }}');
  } else {
    console.log('GA: Not available, page view not tracked');
  }
}

function trackDownload(filename, language) {
  if (typeof gtag !== 'undefined') {
    gtag('event', 'file_download', {
      'file_name': filename,
      'file_extension': 'pdf',
      'page_title': '{{ page.title | escape }}',
      'language': language || 'default',
      'link_url': filename,
      'value': 1,
      'send_to': '{{ site.google_analytics }}'
    });
    console.log('GA: Download tracked:', filename);
  } else {
    console.log('GA: Not available, download not tracked');
  }
}

function updateVisitDisplay(count) {
  const visitCountEl = document.getElementById('visit-count');
  if (visitCountEl) {
    visitCountEl.textContent = count;
  }
}

function updateDownloadDisplay(count) {
  const downloadCountEl = document.getElementById('download-count');
  if (downloadCountEl) {
    downloadCountEl.textContent = count;
  }
}

// Enhanced download tracking for PDF links
function handlePDFDownload(pdfUrl, language) {
  const filename = pdfUrl.split('/').pop();
  
  // Track in Google Analytics
  trackDownload(pdfUrl, language);
  
  // Increment local counter
  incrementDownloadCounter();
}

// Initialize counters and tracking
document.addEventListener('DOMContentLoaded', function() {
  console.log('Pupilla Analytics: Initializing for:', '{{ page.title | escape }}');
  
  // Initialize local counters (no external API calls)
  initializeCounters();
  
  // Track page view in Google Analytics
  trackPageView();
  
  // Add click tracking to all PDF download links
  const pdfLinks = document.querySelectorAll('a[href$=".pdf"], a[href*=".pdf"]');
  pdfLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      const pdfUrl = this.getAttribute('href');
      const language = this.getAttribute('data-lang') || 
                      this.textContent.match(/\(([^)]+)\)/)?.[1] ||
                      this.textContent.trim() || 
                      'default';
      
      console.log('PDF link clicked:', pdfUrl, 'Language:', language);
      handlePDFDownload(pdfUrl, language);
    });
  });
  
  console.log('Pupilla Analytics: Found', pdfLinks.length, 'PDF links');
  
  // Only log GA status if in development
  if (window.location.hostname === 'localhost') {
    console.log('Pupilla Analytics: Google Analytics available:', typeof gtag !== 'undefined');
    console.log('Pupilla Analytics: Tracking ID:', '{{ site.google_analytics }}');
  }
});
</script>
